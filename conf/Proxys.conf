<IfModule mod_ssl.c>
<Macro Proxy $host $port $protocol $proxyip $proxyport $certdir $phpversion>
<VirtualHost *:$port>
    ServerName $host
#    PHPINIDir /srv/www/$host/php

    #ErrorLog  ${APACHE_LOG_DIR}/Proxy_$host_error.log
    #CustomLog ${APACHE_LOG_DIR}/Proxy_$host_access.log combined

    ErrorDocument 503 "<h1></h1<p>The service is not active</p>"
    ProxyPass /error/ !

    UseCanonicalPhysicalPort Off
    UseCanonicalName         Off
    #DocumentRoot             /var/www/html/

    SSLEngine on
    SSLProtocol +TLSv1.3
    SSLHonorCipherOrder on
    SSLCompression off

	<FilesMatch \.php$>
		SetHandler "proxy:unix:/run/php/php$phpversion-fpm.sock|fcgi://localhost"
	</FilesMatch>

#	> Server Status
                LoadModule status_module modules/mod_status.so
                <Location /server-status>
                        SetHandler server-status
                        Order deny,allow
                        Deny from all
                        Allow from 127.0.0.1
                </Location>

    <FilesMatch "\.(cgi|shtml|phtml|php)$">
        SSLOptions +StdEnvVars
    </FilesMatch>
    <Directory /usr/lib/cgi-bin>
        SSLOptions +StdEnvVars
    </Directory>

    SSLCertificateFile    $certdir/cert.pem
    SSLCertificateKeyFile $certdir/privkey.pem

    ProxyRequests Off
    ProxyPreserveHost On

    #SSL Connect
    SSLProxyVerify none
    SSLProxyCheckPeerCN off
    SSLProxyCheckPeerName off
    SSLProxyCheckPeerExpire off

    # HSTS (mod_headers is required) (15768000 seconds = 6 months)
    Header always set Strict-Transport-Security "max-age=15768000"

    # Encoded slashes need to be allowed
    AllowEncodedSlashes     NoDecode

    RewriteEngine on
    RewriteCond %{HTTP:Connection} Upgrade [NC]
    RewriteCond %{HTTP:Upgrade} websocket [NC]
    RewriteRule /(.*) wss://127.0.0.1:$proxyport/$1  [P,L]

    SSLProxyEngine   on
    ProxyRequests    off

    #block Proxy for letsencrypt verification!
    ProxyPass        /.wellknown !

    ProxyPass        / $protocol://$proxyip:$proxyport/ flushpackets=On connectiontimeout=300 timeout=300
    ProxyPassReverse / $protocol://$proxyip:$proxyport/
    ProxyTimeout     600

</VirtualHost>
</Macro>
</ifModule>
